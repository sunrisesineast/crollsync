/*! For license information please see content.js.LICENSE.txt */
(()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,o)}return r}function r(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?n(Object(t),!0).forEach(function(n){o(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):n(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function o(n,r,o){return(r=function(n){var r=function(n){if("object"!=e(n)||!n)return n;var r=n[Symbol.toPrimitive];if(void 0!==r){var o=r.call(n,"string");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}(n);return"symbol"==e(r)?r:r+""}(r))in n?Object.defineProperty(n,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[r]=o,n}function t(){var e,n,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",i=r.toStringTag||"@@toStringTag";function a(r,o,t,i){var a=o&&o.prototype instanceof s?o:s,l=Object.create(a.prototype);return c(l,"_invoke",function(r,o,t){var c,i,a,s=0,l=t||[],f=!1,y={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(n,r){return c=n,i=0,a=e,y.n=r,u}};function p(r,o){for(i=r,a=o,n=0;!f&&s&&!t&&n<l.length;n++){var t,c=l[n],p=y.p,d=c[2];r>3?(t=d===o)&&(a=c[(i=c[4])?5:(i=3,3)],c[4]=c[5]=e):c[0]<=p&&((t=r<2&&p<c[1])?(i=0,y.v=o,y.n=c[1]):p<d&&(t=r<3||c[0]>o||o>d)&&(c[4]=r,c[5]=o,y.n=d,i=0))}if(t||r>1)return u;throw f=!0,o}return function(t,l,d){if(s>1)throw TypeError("Generator is already running");for(f&&1===l&&p(l,d),i=l,a=d;(n=i<2?e:a)||!f;){c||(i?i<3?(i>1&&(y.n=-1),p(i,a)):y.n=a:y.v=a);try{if(s=2,c){if(i||(t="next"),n=c[t]){if(!(n=n.call(c,a)))throw TypeError("iterator result is not an object");if(!n.done)return n;a=n.value,i<2&&(i=0)}else 1===i&&(n=c.return)&&n.call(c),i<2&&(a=TypeError("The iterator does not provide a '"+t+"' method"),i=1);c=e}else if((n=(f=y.n<0)?a:r.call(o,y))!==u)break}catch(n){c=e,i=1,a=n}finally{s=1}}return{value:n,done:f}}}(r,t,i),!0),l}var u={};function s(){}function l(){}function f(){}n=Object.getPrototypeOf;var y=[][o]?n(n([][o]())):(c(n={},o,function(){return this}),n),p=f.prototype=s.prototype=Object.create(y);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,c(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=f,c(p,"constructor",f),c(f,"constructor",l),l.displayName="GeneratorFunction",c(f,i,"GeneratorFunction"),c(p),c(p,i,"Generator"),c(p,o,function(){return this}),c(p,"toString",function(){return"[object Generator]"}),(t=function(){return{w:a,m:d}})()}function c(e,n,r,o){var t=Object.defineProperty;try{t({},"",{})}catch(e){t=0}c=function(e,n,r,o){function i(n,r){c(e,n,function(e){return this._invoke(n,r,e)})}n?t?t(e,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[n]=r:(i("next",0),i("throw",1),i("return",2))},c(e,n,r,o)}function i(e,n,r,o,t,c,i){try{var a=e[c](i),u=a.value}catch(e){return void r(e)}a.done?n(u):Promise.resolve(u).then(o,t)}function a(e){return function(){var n=this,r=arguments;return new Promise(function(o,t){var c=e.apply(n,r);function a(e){i(c,o,t,a,u,"next",e)}function u(e){i(c,o,t,a,u,"throw",e)}a(void 0)})}}console.log("Crunchyroll Sync: Content script loaded");var u=null,s=!1,l=0;function f(){console.log("Crunchyroll Sync: Initializing content script"),new MutationObserver(function(e){e.forEach(function(e){e.addedNodes.forEach(function(e){if(e.nodeType===Node.ELEMENT_NODE){"VIDEO"===e.tagName&&y(e);var n=e.querySelectorAll&&e.querySelectorAll("video");n&&n.length>0&&n.forEach(y)}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("video").forEach(y),chrome.runtime.onMessage.addListener(function(e,n,r){if(console.log("Crunchyroll Sync: Received message:",e),e.action)return function(e,n){w.apply(this,arguments)}(e,r),!0;switch(e.type){case"play":!function(e){u&&(console.log("Crunchyroll Sync: Remote play command"),u.currentTime=e.timestamp,u.play().catch(function(e){console.error("Crunchyroll Sync: Error playing video:",e)}))}(e);break;case"pause":u&&(console.log("Crunchyroll Sync: Remote pause command"),u.pause());break;case"seek":!function(e){u&&(console.log("Crunchyroll Sync: Remote seek command to",e.timestamp),u.currentTime=e.timestamp)}(e);break;case"sync":!function(e){u&&(console.log("Crunchyroll Sync: Sync command"),u.currentTime=e.timestamp,e.shouldPlay?u.play().catch(function(e){console.error("Crunchyroll Sync: Error playing video during sync:",e)}):u.pause())}(e);break;default:console.log("Crunchyroll Sync: Unknown message type:",e.type)}r({success:!0})})}function y(e){!s&&e&&(console.log("Crunchyroll Sync: Hooking video element"),u=e,s=!0,e.addEventListener("play",p),e.addEventListener("pause",d),e.addEventListener("seeked",m),e.addEventListener("timeupdate",h),console.log("Crunchyroll Sync: Video element hooked successfully"))}function p(e){u&&(console.log("Crunchyroll Sync: Local play event"),b({type:"play",timestamp:u.currentTime,url:window.location.href}))}function d(e){u&&(console.log("Crunchyroll Sync: Local pause event"),b({type:"pause",timestamp:u.currentTime,url:window.location.href}))}function m(e){if(u){var n=Date.now();n-l<500||(l=n,console.log("Crunchyroll Sync: Local seek event to",u.currentTime),b({type:"seek",timestamp:u.currentTime,url:window.location.href}))}}function h(e){}function b(e){chrome.runtime.sendMessage({action:"broadcast",event:e}).catch(function(e){console.error("Crunchyroll Sync: Error sending message to background:",e)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f(),window.crunchyrollSync={getCurrentVideoState:function(){return u?{currentTime:u.currentTime,duration:u.duration,paused:u.paused,url:window.location.href}:null},videoElement:function(){return u},isVideoHooked:function(){return s}};var v=null,g=null;function w(){return(w=a(t().m(function e(n,r){var o,c;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,console.log("Crunchyroll Sync: Handling Firebase action:",n.action),o=n.action,e.n="firebaseCreateRoom"===o?1:"firebaseJoinRoom"===o?3:"firebaseBroadcast"===o?5:7;break;case 1:return e.n=2,O(n,r);case 2:return e.a(3,8);case 3:return e.n=4,j(n,r);case 4:return e.a(3,8);case 5:return e.n=6,P(n,r);case 6:return e.a(3,8);case 7:console.log("Crunchyroll Sync: Unknown Firebase action:",n.action),r({success:!1,error:"Unknown action"});case 8:e.n=10;break;case 9:e.p=9,c=e.v,console.error("Crunchyroll Sync: Error handling Firebase action:",c),r({success:!1,error:c.message});case 10:return e.a(2)}},e,null,[[0,9]])}))).apply(this,arguments)}function S(e){return C.apply(this,arguments)}function C(){return(C=a(t().m(function e(n){var r;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!v||!g){e.n=1;break}return e.a(2);case 1:return e.p=1,console.log("Crunchyroll Sync: Initializing Firebase in content script"),e.n=2,E();case 2:v=firebase.initializeApp(n),g=v.database(),console.log("Crunchyroll Sync: Firebase initialized successfully in content script"),e.n=4;break;case 3:throw e.p=3,r=e.v,console.error("Crunchyroll Sync: Error initializing Firebase in content script:",r),r;case 4:return e.a(2)}},e,null,[[1,3]])}))).apply(this,arguments)}function E(){return new Promise(function(e,n){if("undefined"==typeof firebase){var r=chrome.runtime.getURL("libs/firebase-app-compat.js"),o=document.createElement("script");o.src=r,o.onload=function(){var r=document.createElement("script");r.src=chrome.runtime.getURL("libs/firebase-database-compat.js"),r.onload=function(){e()},r.onerror=function(){n(new Error("Failed to load Firebase Database module"))},document.head.appendChild(r)},o.onerror=function(){n(new Error("Failed to load Firebase App module"))},document.head.appendChild(o)}else e()})}function O(e,n){return k.apply(this,arguments)}function k(){return(k=a(t().m(function e(n,r){var o,c,i;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,S(n.firebaseConfig);case 1:return o=n.roomId,c=g.ref("rooms/"+o),e.n=2,c.set({created:Date.now(),createdBy:"extension",episodeUrl:window.location.href,lastActivity:Date.now()});case 2:console.log("Crunchyroll Sync: Room created in Firebase:",o),r({success:!0,roomId:o}),e.n=4;break;case 3:e.p=3,i=e.v,console.error("Crunchyroll Sync: Error creating room in Firebase:",i),r({success:!1,error:i.message});case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function j(e,n){return F.apply(this,arguments)}function F(){return(F=a(t().m(function e(n,r){var o,c,i;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,S(n.firebaseConfig);case 1:return o=n.roomId,c=g.ref("rooms/"+o),e.n=2,c.once("value");case 2:if(e.v.exists()){e.n=3;break}throw new Error("Room does not exist");case 3:return e.n=4,c.update({lastActivity:Date.now()});case 4:console.log("Crunchyroll Sync: Joined room in Firebase:",o),r({success:!0,roomId:o}),e.n=6;break;case 5:e.p=5,i=e.v,console.error("Crunchyroll Sync: Error joining room in Firebase:",i),r({success:!1,error:i.message});case 6:return e.a(2)}},e,null,[[0,5]])}))).apply(this,arguments)}function P(e,n){return T.apply(this,arguments)}function T(){return(T=a(t().m(function e(n,o){var c,i,a,u,s;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,g){e.n=1;break}throw new Error("Firebase not initialized");case 1:return c=n.event,i=n.roomId,a=r(r({},c),{},{timestamp:Date.now(),sentBy:"extension"}),u=g.ref("rooms/"+i),e.n=2,u.child("events").push(a);case 2:console.log("Crunchyroll Sync: Event broadcasted to Firebase:",a),o({success:!0}),e.n=4;break;case 3:e.p=3,s=e.v,console.error("Crunchyroll Sync: Error broadcasting to Firebase:",s),o({success:!1,error:s.message});case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}})();