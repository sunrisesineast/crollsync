(()=>{function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}function n(e,n){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),o.push.apply(o,t)}return o}function o(e){for(var o=1;o<arguments.length;o++){var r=null!=arguments[o]?arguments[o]:{};o%2?n(Object(r),!0).forEach(function(n){t(e,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))})}return e}function t(n,o,t){return(o=function(n){var o=function(n){if("object"!=e(n)||!n)return n;var o=n[Symbol.toPrimitive];if(void 0!==o){var t=o.call(n,"string");if("object"!=e(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}(n);return"symbol"==e(o)?o:o+""}(o))in n?Object.defineProperty(n,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[o]=t,n}console.log("Crunchyroll Sync: Content script loaded on",window.location.href);var r=null,c=!1,l=0,i=!1,u=new Set;function s(){console.log("Crunchyroll Sync: Initializing content script"),new MutationObserver(function(e){e.forEach(function(e){e.addedNodes.forEach(function(e){if(e.nodeType===Node.ELEMENT_NODE){"VIDEO"===e.tagName&&a(e);var n=e.querySelectorAll&&e.querySelectorAll("video");n&&n.length>0&&n.forEach(a)}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("video").forEach(a),chrome.runtime.onMessage.addListener(function(e,n,o){if(console.log("Crunchyroll Sync: Received message:",e),e.action)return function(e,n){console.warn("Crunchyroll Sync: Firebase actions are no longer handled in content script"),n({success:!1,error:"Unsupported in content script"})}(0,o),!0;if(e.sentAtMs&&u.has(e.sentAtMs))return console.log("Crunchyroll Sync: Ignoring own event from",e.sentAtMs),void o({success:!0});switch(e.type){case"play":!function(e){var n,o;r&&(console.log("Crunchyroll Sync: Remote play command"),i=!0,r.currentTime=null!==(n=null!==(o=e.positionSec)&&void 0!==o?o:e.timestamp)&&void 0!==n?n:r.currentTime,r.play().catch(function(e){console.error("Crunchyroll Sync: Error playing video:",e)}).finally(function(){setTimeout(function(){i=!1},250)}))}(e);break;case"pause":r&&(console.log("Crunchyroll Sync: Remote pause command"),i=!0,r.pause(),setTimeout(function(){i=!1},250));break;case"seek":!function(e){var n,o;r&&(console.log("Crunchyroll Sync: Remote seek command to",e.timestamp),i=!0,r.currentTime=null!==(n=null!==(o=e.positionSec)&&void 0!==o?o:e.timestamp)&&void 0!==n?n:r.currentTime,setTimeout(function(){i=!1},250))}(e);break;case"sync":!function(e){r&&(console.log("Crunchyroll Sync: Sync command"),i=!0,r.currentTime=e.timestamp,e.shouldPlay?r.play().catch(function(e){console.error("Crunchyroll Sync: Error playing video during sync:",e)}).finally(function(){setTimeout(function(){i=!1},250)}):(r.pause(),setTimeout(function(){i=!1},250)))}(e);break;default:console.log("Crunchyroll Sync: Unknown message type:",e.type)}o({success:!0})})}function a(e){!c&&e&&(console.log("Crunchyroll Sync: Hooking video element"),r=e,c=!0,e.addEventListener("play",y),e.addEventListener("pause",d),e.addEventListener("seeked",f),e.addEventListener("timeupdate",p),console.log("Crunchyroll Sync: Video element hooked successfully"))}function y(e){r&&(i?console.log("Crunchyroll Sync: Ignoring local play (applying remote)"):(console.log("Crunchyroll Sync: Local play event"),m({type:"play",positionSec:r.currentTime,url:window.location.href})))}function d(e){r&&(i?console.log("Crunchyroll Sync: Ignoring local pause (applying remote)"):(console.log("Crunchyroll Sync: Local pause event"),m({type:"pause",positionSec:r.currentTime,url:window.location.href})))}function f(e){if(r)if(i)console.log("Crunchyroll Sync: Ignoring local seek (applying remote)");else{var n=Date.now();n-l<500||(l=n,console.log("Crunchyroll Sync: Local seek event to",r.currentTime),m({type:"seek",positionSec:r.currentTime,url:window.location.href}))}}function p(e){}function m(e){var n=Date.now();u.add(n),setTimeout(function(){u.delete(n)},5e3);var t=o(o({},e),{},{localSentAt:n});chrome.runtime.sendMessage({action:"broadcast",event:t}).catch(function(e){console.error("Crunchyroll Sync: Error sending message to background:",e)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),window.crunchyrollSync={getCurrentVideoState:function(){return r?{currentTime:r.currentTime,duration:r.duration,paused:r.paused,url:window.location.href}:null},videoElement:function(){return r},isVideoHooked:function(){return c}}})();