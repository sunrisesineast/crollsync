/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";var r,e,n={988:(r,e,n)=>{var o=n(223),t=n(290);function c(r){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},c(r)}function s(r,e){var n=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.push.apply(n,o)}return n}function i(r){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach(function(e){a(r,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(n,e))})}return r}function a(r,e,n){return(e=function(r){var e=function(r){if("object"!=c(r)||!r)return r;var e=r[Symbol.toPrimitive];if(void 0!==e){var n=e.call(r,"string");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}(r);return"symbol"==c(e)?e:e+""}(e))in r?Object.defineProperty(r,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):r[e]=n,r}function u(){var r,e,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",t=n.toStringTag||"@@toStringTag";function c(n,o,t,c){var a=o&&o.prototype instanceof i?o:i,u=Object.create(a.prototype);return l(u,"_invoke",function(n,o,t){var c,i,a,u=0,l=t||[],y=!1,f={p:0,n:0,v:r,a:p,f:p.bind(r,4),d:function(e,n){return c=e,i=0,a=r,f.n=n,s}};function p(n,o){for(i=n,a=o,e=0;!y&&u&&!t&&e<l.length;e++){var t,c=l[e],p=f.p,h=c[2];n>3?(t=h===o)&&(a=c[(i=c[4])?5:(i=3,3)],c[4]=c[5]=r):c[0]<=p&&((t=n<2&&p<c[1])?(i=0,f.v=o,f.n=c[1]):p<h&&(t=n<3||c[0]>o||o>h)&&(c[4]=n,c[5]=o,f.n=h,i=0))}if(t||n>1)return s;throw y=!0,o}return function(t,l,h){if(u>1)throw TypeError("Generator is already running");for(y&&1===l&&p(l,h),i=l,a=h;(e=i<2?r:a)||!y;){c||(i?i<3?(i>1&&(f.n=-1),p(i,a)):f.n=a:f.v=a);try{if(u=2,c){if(i||(t="next"),e=c[t]){if(!(e=e.call(c,a)))throw TypeError("iterator result is not an object");if(!e.done)return e;a=e.value,i<2&&(i=0)}else 1===i&&(e=c.return)&&e.call(c),i<2&&(a=TypeError("The iterator does not provide a '"+t+"' method"),i=1);c=r}else if((e=(y=f.n<0)?a:n.call(o,f))!==s)break}catch(e){c=r,i=1,a=e}finally{u=1}}return{value:e,done:y}}}(n,t,c),!0),u}var s={};function i(){}function a(){}function y(){}e=Object.getPrototypeOf;var f=[][o]?e(e([][o]())):(l(e={},o,function(){return this}),e),p=y.prototype=i.prototype=Object.create(f);function h(r){return Object.setPrototypeOf?Object.setPrototypeOf(r,y):(r.__proto__=y,l(r,t,"GeneratorFunction")),r.prototype=Object.create(p),r}return a.prototype=y,l(p,"constructor",y),l(y,"constructor",a),a.displayName="GeneratorFunction",l(y,t,"GeneratorFunction"),l(p),l(p,t,"Generator"),l(p,o,function(){return this}),l(p,"toString",function(){return"[object Generator]"}),(u=function(){return{w:c,m:h}})()}function l(r,e,n,o){var t=Object.defineProperty;try{t({},"",{})}catch(r){t=0}l=function(r,e,n,o){function c(e,n){l(r,e,function(r){return this._invoke(e,n,r)})}e?t?t(r,e,{value:n,enumerable:!o,configurable:!o,writable:!o}):r[e]=n:(c("next",0),c("throw",1),c("return",2))},l(r,e,n,o)}function y(r,e,n,o,t,c,s){try{var i=r[c](s),a=i.value}catch(r){return void n(r)}i.done?e(a):Promise.resolve(a).then(o,t)}function f(r){return function(){var e=this,n=arguments;return new Promise(function(o,t){var c=r.apply(e,n);function s(r){y(c,o,t,s,i,"next",r)}function i(r){y(c,o,t,s,i,"throw",r)}s(void 0)})}}console.log("Crunchyroll Sync: Background script loaded");var p={apiKey:"AIzaSyBPEckKjp8aFmX58uos3MaK873RGuL30Nc",authDomain:"crunchysync-fe757.firebaseapp.com",databaseURL:"https://crunchysync-fe757-default-rtdb.firebaseio.com",projectId:"crunchysync-fe757",storageBucket:"crunchysync-fe757.firebasestorage.app",messagingSenderId:"891082210535",appId:"1:891082210535:web:53225e1bebc5b5d2e03642"},h=null,g=null,m=null,b=null;function d(){console.log("Crunchyroll Sync: Initializing Firebase Database in service worker");try{h=(0,o.Wp)(p),g=(0,t.C3)(h),console.log("Crunchyroll Sync: Firebase Database initialized successfully in service worker")}catch(r){console.error("Crunchyroll Sync: Error initializing Firebase:",r),console.error("Stack:",r.stack)}}function v(){return(v=f(u().m(function r(e,n){var o,c,s;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:if(r.p=0,o=e.roomId,console.log("Crunchyroll Sync: Creating room:",o),g){r.n=1;break}throw new Error("Firebase not initialized");case 1:return c=(0,t.KR)(g,"rooms/"+o),r.n=2,(0,t.hZ)(c,{created:Date.now(),createdBy:"extension",lastActivity:Date.now()});case 2:m=c,b=o,k(),console.log("Crunchyroll Sync: Room created successfully:",o),n({success:!0,roomId:o}),r.n=4;break;case 3:r.p=3,s=r.v,console.error("Crunchyroll Sync: Error creating room:",s),n({success:!1,error:s.message});case 4:return r.a(2)}},r,null,[[0,3]])}))).apply(this,arguments)}function w(){return(w=f(u().m(function r(e,n){var o,c,s;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:if(r.p=0,o=e.roomId,console.log("Crunchyroll Sync: Joining room:",o),g){r.n=1;break}throw new Error("Firebase not initialized");case 1:return c=(0,t.KR)(g,"rooms/"+o),r.n=2,(0,t.Jt)(c);case 2:if(r.v.exists()){r.n=3;break}throw new Error("Room does not exist");case 3:return r.n=4,(0,t.yo)(c,{lastActivity:Date.now()});case 4:m=c,b=o,k(),console.log("Crunchyroll Sync: Joined room successfully:",o),n({success:!0,roomId:o}),r.n=6;break;case 5:r.p=5,s=r.v,console.error("Crunchyroll Sync: Error joining room:",s),n({success:!1,error:s.message});case 6:return r.a(2)}},r,null,[[0,5]])}))).apply(this,arguments)}function S(){return(S=f(u().m(function r(e,n){var o;return u().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Leaving room"),m&&(o=(0,t.KR)(g,"rooms/"+b+"/events"),(0,t.AU)(o,"child_added"),m=null,b=null),console.log("Crunchyroll Sync: Left room successfully"),n({success:!0})}catch(r){console.error("Crunchyroll Sync: Error leaving room:",r),n({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function C(){return(C=f(u().m(function r(e,n){var o,c,s,a;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:if(r.p=0,m){r.n=1;break}throw new Error("Not connected to any room");case 1:return o=e.event,console.log("Crunchyroll Sync: Broadcasting event:",o),c=i(i({},o),{},{timestamp:Date.now(),sentBy:"extension"}),s=(0,t.KR)(g,"rooms/"+b+"/events"),r.n=2,(0,t.VC)(s,c);case 2:return r.n=3,(0,t.yo)(m,{lastActivity:Date.now()});case 3:console.log("Crunchyroll Sync: Event broadcasted successfully"),n({success:!0}),r.n=5;break;case 4:r.p=4,a=r.v,console.error("Crunchyroll Sync: Error broadcasting event:",a),n({success:!1,error:a.message});case 5:return r.a(2)}},r,null,[[0,4]])}))).apply(this,arguments)}function k(r){console.log("Crunchyroll Sync: Setting up room listener");var e=(0,t.KR)(g,"rooms/"+b+"/events");(0,t.Zy)(e,function(r){if(r.exists()){var e=r.val(),n=Object.keys(e),o=e[n[n.length-1]];console.log("Crunchyroll Sync: Received event:",o),chrome.tabs.query({url:"https://www.crunchyroll.com/*"},function(r){r.forEach(function(r){chrome.tabs.sendMessage(r.id,o).catch(function(r){console.error("Crunchyroll Sync: Error sending message to tab:",r)})})})}})}function O(){return(O=f(u().m(function r(e){var n;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling Google sign-in"),r.n=1,R();case 1:e({success:!0}),r.n=3;break;case 2:r.p=2,n=r.v,console.error("Crunchyroll Sync: Error handling Google sign-in:",n),e({success:!1,error:n.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function j(){return(j=f(u().m(function r(e){var n;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling anonymous sign-in"),r.n=1,R();case 1:e({success:!0}),r.n=3;break;case 2:r.p=2,n=r.v,console.error("Crunchyroll Sync: Error handling anonymous sign-in:",n),e({success:!1,error:n.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function E(){return(E=f(u().m(function r(e){var n;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling sign-out"),r.n=1,R();case 1:e({success:!0}),r.n=3;break;case 2:r.p=2,n=r.v,console.error("Crunchyroll Sync: Error handling sign-out:",n),e({success:!1,error:n.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function P(){return(P=f(u().m(function r(e){return u().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Getting current user"),e({success:!0,user:null})}catch(r){console.error("Crunchyroll Sync: Error getting current user:",r),e({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function x(){return(x=f(u().m(function r(e,n){return u().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Auth state changed:",e.user?"signed in":"signed out"),chrome.tabs.query({url:"https://www.crunchyroll.com/*"},function(r){r.forEach(function(r){chrome.tabs.sendMessage(r.id,{action:"authStateChanged",user:e.user}).catch(function(r){console.error("Crunchyroll Sync: Error sending auth state to tab:",r)})})}),n({success:!0})}catch(r){console.error("Crunchyroll Sync: Error handling auth state change:",r),n({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function R(){return D.apply(this,arguments)}function D(){return(D=f(u().m(function r(){var e;return u().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]});case 1:if(!(r.v.length>0)){r.n=2;break}return console.log("Crunchyroll Sync: Offscreen document already exists"),r.a(2);case 2:return console.log("Crunchyroll Sync: Creating offscreen document"),r.n=3,chrome.offscreen.createDocument({url:"offscreen.html",reasons:["USER_MEDIA"],justification:"Authentication popup for Firebase sign-in"});case 3:console.log("Crunchyroll Sync: Offscreen document created successfully"),r.n=5;break;case 4:throw r.p=4,e=r.v,console.error("Crunchyroll Sync: Error creating offscreen document:",e),e;case 5:return r.a(2)}},r,null,[[0,4]])}))).apply(this,arguments)}chrome.runtime.onStartup.addListener(function(){console.log("Crunchyroll Sync: Service worker started"),d()}),chrome.runtime.onInstalled.addListener(function(){console.log("Crunchyroll Sync: Extension installed"),d()}),chrome.runtime.onMessage.addListener(function(r,e,n){switch(console.log("Crunchyroll Sync: Background received message:",r),r.action){case"createRoom":!function(r,e){v.apply(this,arguments)}(r,n);break;case"joinRoom":!function(r,e){w.apply(this,arguments)}(r,n);break;case"leaveRoom":!function(r,e){S.apply(this,arguments)}(r,n);break;case"broadcast":!function(r,e){C.apply(this,arguments)}(r,n);break;case"signInWithGoogle":!function(r){O.apply(this,arguments)}(n);break;case"signInAnonymously":!function(r){j.apply(this,arguments)}(n);break;case"signOut":!function(r){E.apply(this,arguments)}(n);break;case"getCurrentUser":!function(r){P.apply(this,arguments)}(n);break;case"authStateChanged":!function(r,e){x.apply(this,arguments)}(r,n);break;default:console.log("Crunchyroll Sync: Unknown action:",r.action),n({success:!1,error:"Unknown action"})}return!0}),chrome.runtime.onSuspend.addListener(function(){console.log("Crunchyroll Sync: Service worker suspending"),m&&m.child("events").off("child_added")})}},o={};function t(r){var e=o[r];if(void 0!==e)return e.exports;var c=o[r]={exports:{}};return n[r](c,c.exports,t),c.exports}t.m=n,t.x=()=>{var r=t.O(void 0,[396],()=>t(988));return t.O(r)},r=[],t.O=(e,n,o,c)=>{if(!n){var s=1/0;for(l=0;l<r.length;l++){for(var[n,o,c]=r[l],i=!0,a=0;a<n.length;a++)(!1&c||s>=c)&&Object.keys(t.O).every(r=>t.O[r](n[a]))?n.splice(a--,1):(i=!1,c<s&&(s=c));if(i){r.splice(l--,1);var u=o();void 0!==u&&(e=u)}}return e}c=c||0;for(var l=r.length;l>0&&r[l-1][2]>c;l--)r[l]=r[l-1];r[l]=[n,o,c]},t.d=(r,e)=>{for(var n in e)t.o(e,n)&&!t.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},t.f={},t.e=r=>Promise.all(Object.keys(t.f).reduce((e,n)=>(t.f[n](r,e),e),[])),t.u=r=>r+".js",t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(r){if("object"==typeof window)return window}}(),t.o=(r,e)=>Object.prototype.hasOwnProperty.call(r,e),(()=>{var r;t.g.importScripts&&(r=t.g.location+"");var e=t.g.document;if(!r&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(r=e.currentScript.src),!r)){var n=e.getElementsByTagName("script");if(n.length)for(var o=n.length-1;o>-1&&(!r||!/^http(s?):/.test(r));)r=n[o--].src}if(!r)throw new Error("Automatic publicPath is not supported in this browser");r=r.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=r})(),(()=>{var r={471:1};t.f.i=(e,n)=>{r[e]||importScripts(t.p+t.u(e))};var e=self.webpackChunkcrunchyroll_sync_extension=self.webpackChunkcrunchyroll_sync_extension||[],n=e.push.bind(e);e.push=e=>{var[o,c,s]=e;for(var i in c)t.o(c,i)&&(t.m[i]=c[i]);for(s&&s(t);o.length;)r[o.pop()]=1;n(e)}})(),e=t.x,t.x=()=>t.e(396).then(e),t.x()})();