/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";var r,n,e={988:(r,n,e)=>{var o=e(223),t=e(290);function c(r){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},c(r)}function s(r,n){var e=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),e.push.apply(e,o)}return e}function u(r){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?s(Object(e),!0).forEach(function(n){i(r,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(e)):s(Object(e)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(e,n))})}return r}function i(r,n,e){return(n=function(r){var n=function(r){if("object"!=c(r)||!r)return r;var n=r[Symbol.toPrimitive];if(void 0!==n){var e=n.call(r,"string");if("object"!=c(e))return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}(r);return"symbol"==c(n)?n:n+""}(n))in r?Object.defineProperty(r,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[n]=e,r}function a(){var r,n,e="function"==typeof Symbol?Symbol:{},o=e.iterator||"@@iterator",t=e.toStringTag||"@@toStringTag";function c(e,o,t,c){var i=o&&o.prototype instanceof u?o:u,a=Object.create(i.prototype);return l(a,"_invoke",function(e,o,t){var c,u,i,a=0,l=t||[],y=!1,f={p:0,n:0,v:r,a:p,f:p.bind(r,4),d:function(n,e){return c=n,u=0,i=r,f.n=e,s}};function p(e,o){for(u=e,i=o,n=0;!y&&a&&!t&&n<l.length;n++){var t,c=l[n],p=f.p,h=c[2];e>3?(t=h===o)&&(i=c[(u=c[4])?5:(u=3,3)],c[4]=c[5]=r):c[0]<=p&&((t=e<2&&p<c[1])?(u=0,f.v=o,f.n=c[1]):p<h&&(t=e<3||c[0]>o||o>h)&&(c[4]=e,c[5]=o,f.n=h,u=0))}if(t||e>1)return s;throw y=!0,o}return function(t,l,h){if(a>1)throw TypeError("Generator is already running");for(y&&1===l&&p(l,h),u=l,i=h;(n=u<2?r:i)||!y;){c||(u?u<3?(u>1&&(f.n=-1),p(u,i)):f.n=i:f.v=i);try{if(a=2,c){if(u||(t="next"),n=c[t]){if(!(n=n.call(c,i)))throw TypeError("iterator result is not an object");if(!n.done)return n;i=n.value,u<2&&(u=0)}else 1===u&&(n=c.return)&&n.call(c),u<2&&(i=TypeError("The iterator does not provide a '"+t+"' method"),u=1);c=r}else if((n=(y=f.n<0)?i:e.call(o,f))!==s)break}catch(n){c=r,u=1,i=n}finally{a=1}}return{value:n,done:y}}}(e,t,c),!0),a}var s={};function u(){}function i(){}function y(){}n=Object.getPrototypeOf;var f=[][o]?n(n([][o]())):(l(n={},o,function(){return this}),n),p=y.prototype=u.prototype=Object.create(f);function h(r){return Object.setPrototypeOf?Object.setPrototypeOf(r,y):(r.__proto__=y,l(r,t,"GeneratorFunction")),r.prototype=Object.create(p),r}return i.prototype=y,l(p,"constructor",y),l(y,"constructor",i),i.displayName="GeneratorFunction",l(y,t,"GeneratorFunction"),l(p),l(p,t,"Generator"),l(p,o,function(){return this}),l(p,"toString",function(){return"[object Generator]"}),(a=function(){return{w:c,m:h}})()}function l(r,n,e,o){var t=Object.defineProperty;try{t({},"",{})}catch(r){t=0}l=function(r,n,e,o){function c(n,e){l(r,n,function(r){return this._invoke(n,e,r)})}n?t?t(r,n,{value:e,enumerable:!o,configurable:!o,writable:!o}):r[n]=e:(c("next",0),c("throw",1),c("return",2))},l(r,n,e,o)}function y(r,n,e,o,t,c,s){try{var u=r[c](s),i=u.value}catch(r){return void e(r)}u.done?n(i):Promise.resolve(i).then(o,t)}function f(r){return function(){var n=this,e=arguments;return new Promise(function(o,t){var c=r.apply(n,e);function s(r){y(c,o,t,s,u,"next",r)}function u(r){y(c,o,t,s,u,"throw",r)}s(void 0)})}}var p=null,h=null,g=null,m=null;function d(){if(!p||!h)try{console.log("Crunchyroll Sync: Initializing Firebase for service worker"),p=(0,o.Wp)(b),h=(0,t.C3)(p),console.log("Crunchyroll Sync: Firebase initialized successfully for service worker")}catch(r){throw console.error("Crunchyroll Sync: Failed to initialize Firebase:",r),r}}console.log("Crunchyroll Sync: Background script loaded");var b={apiKey:"AIzaSyBPEckKjp8aFmX58uos3MaK873RGuL30Nc",authDomain:"crunchysync-fe757.firebaseapp.com",databaseURL:"https://crunchysync-fe757-default-rtdb.firebaseio.com",projectId:"crunchysync-fe757",storageBucket:"crunchysync-fe757.firebasestorage.app",messagingSenderId:"891082210535",appId:"1:891082210535:web:53225e1bebc5b5d2e03642"};function v(){return(v=f(a().m(function r(n,e){var o,c,s;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,o=n.roomId,console.log("Crunchyroll Sync: Creating room:",o),d(),c=(0,t.KR)(h,"rooms/"+o),r.n=1,(0,t.hZ)(c,{created:Date.now(),createdBy:"extension",lastActivity:Date.now()});case 1:return g=c,m=o,r.n=2,O(c);case 2:console.log("Crunchyroll Sync: Room created successfully:",o),e({success:!0,roomId:o}),r.n=4;break;case 3:r.p=3,s=r.v,console.error("Crunchyroll Sync: Error creating room:",s),e({success:!1,error:s.message});case 4:return r.a(2)}},r,null,[[0,3]])}))).apply(this,arguments)}function S(){return(S=f(a().m(function r(n,e){var o,c,s;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,o=n.roomId,console.log("Crunchyroll Sync: Joining room:",o),d(),c=(0,t.KR)(h,"rooms/"+o),r.n=1,(0,t.Jt)(c);case 1:if(r.v.exists()){r.n=2;break}throw new Error("Room does not exist");case 2:return r.n=3,(0,t.yo)(c,{lastActivity:Date.now()});case 3:g=c,m=o,O(c),console.log("Crunchyroll Sync: Joined room successfully:",o),e({success:!0,roomId:o}),r.n=5;break;case 4:r.p=4,s=r.v,console.error("Crunchyroll Sync: Error joining room:",s),e({success:!1,error:s.message});case 5:return r.a(2)}},r,null,[[0,4]])}))).apply(this,arguments)}function w(){return(w=f(a().m(function r(n,e){var o;return a().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Leaving room"),g&&(o=(0,t.KR)(h,"rooms/"+m+"/events"),(0,t.AU)(o,"child_added"),g=null,m=null),console.log("Crunchyroll Sync: Left room successfully"),e({success:!0})}catch(r){console.error("Crunchyroll Sync: Error leaving room:",r),e({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function C(){return(C=f(a().m(function r(n,e,o){var c,s,i,l;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:if(r.p=0,g){r.n=1;break}throw new Error("Not connected to any room");case 1:return c=n.event,console.log("Crunchyroll Sync: Broadcasting event:",c),s=u(u({},c),{},{sentAtMs:Date.now(),sentBy:"extension",originTabId:e&&e.tab?e.tab.id:null}),i=(0,t.KR)(h,"rooms/"+m+"/events"),r.n=2,(0,t.VC)(i,s);case 2:return r.n=3,(0,t.yo)(g,{lastActivity:Date.now()});case 3:console.log("Crunchyroll Sync: Event broadcasted successfully"),o({success:!0}),r.n=5;break;case 4:r.p=4,l=r.v,console.error("Crunchyroll Sync: Error broadcasting event:",l),o({success:!1,error:l.message});case 5:return r.a(2)}},r,null,[[0,4]])}))).apply(this,arguments)}function O(r){return k.apply(this,arguments)}function k(){return(k=f(a().m(function r(n){var e;return a().w(function(r){for(;;)switch(r.n){case 0:console.log("Crunchyroll Sync: Setting up room listener");try{e=(0,t.KR)(h,"rooms/"+m+"/events"),(0,t._O)(e,function(r){var n=r.val();console.log("Crunchyroll Sync: Received event:",n),chrome.tabs.query({url:["https://*.crunchyroll.com/*","https://static.crunchyroll.com/*"]},function(r){r.forEach(function(r){chrome.tabs.sendMessage(r.id,n,{frameId:void 0}).catch(function(n){console.log("Crunchyroll Sync: Tab",r.id,"not ready or no content script")})})})})}catch(r){console.error("Crunchyroll Sync: Error setting up room listener:",r)}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function j(){return(j=f(a().m(function r(n){var e;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling Google sign-in"),r.n=1,R();case 1:n({success:!0}),r.n=3;break;case 2:r.p=2,e=r.v,console.error("Crunchyroll Sync: Error handling Google sign-in:",e),n({success:!1,error:e.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function E(){return(E=f(a().m(function r(n){var e;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling anonymous sign-in"),r.n=1,R();case 1:n({success:!0}),r.n=3;break;case 2:r.p=2,e=r.v,console.error("Crunchyroll Sync: Error handling anonymous sign-in:",e),n({success:!1,error:e.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function P(){return(P=f(a().m(function r(n){var e;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Crunchyroll Sync: Handling sign-out"),r.n=1,R();case 1:n({success:!0}),r.n=3;break;case 2:r.p=2,e=r.v,console.error("Crunchyroll Sync: Error handling sign-out:",e),n({success:!1,error:e.message});case 3:return r.a(2)}},r,null,[[0,2]])}))).apply(this,arguments)}function x(){return(x=f(a().m(function r(n){return a().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Getting current user"),n({success:!0,user:null})}catch(r){console.error("Crunchyroll Sync: Error getting current user:",r),n({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function I(){return(I=f(a().m(function r(n,e){return a().w(function(r){for(;;)switch(r.n){case 0:try{console.log("Crunchyroll Sync: Auth state changed:",n.user?"signed in":"signed out"),chrome.tabs.query({url:["https://*.crunchyroll.com/*","https://static.crunchyroll.com/*"]},function(r){r.forEach(function(r){chrome.tabs.sendMessage(r.id,{action:"authStateChanged",user:n.user}).catch(function(r){console.error("Crunchyroll Sync: Error sending auth state to tab:",r)})})}),e({success:!0})}catch(r){console.error("Crunchyroll Sync: Error handling auth state change:",r),e({success:!1,error:r.message})}case 1:return r.a(2)}},r)}))).apply(this,arguments)}function R(){return T.apply(this,arguments)}function T(){return(T=f(a().m(function r(){var n;return a().w(function(r){for(;;)switch(r.p=r.n){case 0:return console.log("Crunchyroll Sync: createOffscreenDocument called"),r.p=1,r.n=2,chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]});case 2:if(!(r.v.length>0)){r.n=3;break}return console.log("Crunchyroll Sync: Offscreen document already exists"),r.a(2);case 3:return console.log("Crunchyroll Sync: Creating offscreen document"),r.n=4,chrome.offscreen.createDocument({url:"offscreen.html",reasons:["IFRAME_SCRIPTING"],justification:"Authentication UI for Firebase sign-in"});case 4:console.log("Crunchyroll Sync: Offscreen document created successfully"),r.n=6;break;case 5:r.p=5,n=r.v,console.error("Crunchyroll Sync: Error creating offscreen document:",n);case 6:return r.a(2)}},r,null,[[1,5]])}))).apply(this,arguments)}chrome.runtime.onStartup.addListener(function(){console.log("Crunchyroll Sync: Service worker started")}),chrome.runtime.onInstalled.addListener(function(){console.log("Crunchyroll Sync: Extension installed")}),chrome.runtime.onMessage.addListener(function(r,n,e){switch(console.log("Crunchyroll Sync: Background received message:",r),r.action){case"ping":e({success:!0,status:"ok"});break;case"createRoom":!function(r,n){v.apply(this,arguments)}(r,e);break;case"joinRoom":!function(r,n){S.apply(this,arguments)}(r,e);break;case"leaveRoom":!function(r,n){w.apply(this,arguments)}(r,e);break;case"broadcast":!function(r,n,e){C.apply(this,arguments)}(r,n,e);break;case"signInWithGoogle":!function(r){j.apply(this,arguments)}(e);break;case"signInAnonymously":!function(r){E.apply(this,arguments)}(e);break;case"signOut":!function(r){P.apply(this,arguments)}(e);break;case"getCurrentUser":!function(r){x.apply(this,arguments)}(e);break;case"authStateChanged":!function(r,n){I.apply(this,arguments)}(r,e);break;default:console.log("Crunchyroll Sync: Unknown action:",r.action),e({success:!1,error:"Unknown action"})}return!0}),chrome.runtime.onSuspend.addListener(function(){console.log("Crunchyroll Sync: Service worker suspending"),g&&g.child("events").off("child_added")})}},o={};function t(r){var n=o[r];if(void 0!==n)return n.exports;var c=o[r]={exports:{}};return e[r](c,c.exports,t),c.exports}t.m=e,t.x=()=>{var r=t.O(void 0,[396],()=>t(988));return t.O(r)},r=[],t.O=(n,e,o,c)=>{if(!e){var s=1/0;for(l=0;l<r.length;l++){for(var[e,o,c]=r[l],u=!0,i=0;i<e.length;i++)(!1&c||s>=c)&&Object.keys(t.O).every(r=>t.O[r](e[i]))?e.splice(i--,1):(u=!1,c<s&&(s=c));if(u){r.splice(l--,1);var a=o();void 0!==a&&(n=a)}}return n}c=c||0;for(var l=r.length;l>0&&r[l-1][2]>c;l--)r[l]=r[l-1];r[l]=[e,o,c]},t.d=(r,n)=>{for(var e in n)t.o(n,e)&&!t.o(r,e)&&Object.defineProperty(r,e,{enumerable:!0,get:n[e]})},t.f={},t.e=r=>Promise.all(Object.keys(t.f).reduce((n,e)=>(t.f[e](r,n),n),[])),t.u=r=>r+".js",t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(r){if("object"==typeof window)return window}}(),t.o=(r,n)=>Object.prototype.hasOwnProperty.call(r,n),(()=>{var r;t.g.importScripts&&(r=t.g.location+"");var n=t.g.document;if(!r&&n&&(n.currentScript&&"SCRIPT"===n.currentScript.tagName.toUpperCase()&&(r=n.currentScript.src),!r)){var e=n.getElementsByTagName("script");if(e.length)for(var o=e.length-1;o>-1&&(!r||!/^http(s?):/.test(r));)r=e[o--].src}if(!r)throw new Error("Automatic publicPath is not supported in this browser");r=r.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=r})(),(()=>{var r={471:1};t.f.i=(n,e)=>{r[n]||importScripts(t.p+t.u(n))};var n=self.webpackChunkcrunchyroll_sync_extension=self.webpackChunkcrunchyroll_sync_extension||[],e=n.push.bind(n);n.push=n=>{var[o,c,s]=n;for(var u in c)t.o(c,u)&&(t.m[u]=c[u]);for(s&&s(t);o.length;)r[o.pop()]=1;e(n)}})(),n=t.x,t.x=()=>t.e(396).then(n),t.x()})();